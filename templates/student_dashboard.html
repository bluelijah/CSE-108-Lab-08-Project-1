{% extends "base.html" %}
{% block title %}Student Dashboard · ACME{% endblock %}

{% block content %}
  <div class="card" style="margin-bottom:20px;">
    <div class="card-header">
      <h2 class="card-title">Welcome {{ full_name }}!</h2>
      <span class="badge">Student Portal</span>
    </div>
  </div>

  <!-- Alert messages -->
  <div id="alert-container" style="margin-bottom:20px;"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="mine" onclick="showTab('mine')">Your Courses</button>
    <button class="tab" data-tab="add" onclick="showTab('add')">Add Courses</button>
  </div>

  <!-- Your Courses -->
  <section id="tab-mine" class="card tab-panel">
    <div class="card-header"><h3 class="card-title">Your Courses</h3></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Course Name</th><th>Teacher</th><th>Time</th><th>Students</th><th></th></tr>
        </thead>
        <tbody>
          {% for c in my_courses %}
            <tr>
              <td>{{ c.course_name }}</td>
              <td>{{ c.teacher }}</td>
              <td>{{ c.time }}</td>
              <td>{{ c.enrolled }}/{{ c.capacity }}</td>
              <td style="text-align:right;">
                <button class="btn btn-ghost" onclick="unenroll({{ c.id }})">Remove</button>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="5" style="text-align:center;">You’re not enrolled in any courses yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Add Courses -->
  <section id="tab-add" class="card tab-panel is-hidden">
    <div class="card-header"><h3 class="card-title">Add Courses</h3></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Course</th><th>Teacher</th><th>Time</th><th>Seats</th><th></th></tr>
        </thead>
        <tbody>
          {% for c in available_courses %}
            <tr>
              <td>{{ c.course_name }}</td>
              <td>{{ c.teacher }}</td>
              <td>{{ c.time }}</td>
              <td>{{ c.enrolled }}/{{ c.capacity }}</td>
              <td style="text-align:right;">
                <button class="btn btn-primary" onclick="enroll({{ c.id }})"
                        {% if c.is_full or c.is_enrolled %}disabled{% endif %}>
                  {% if c.is_enrolled %}Enrolled{% elif c.is_full %}Full{% else %}Add{% endif %}
                </button>
              </td>
            </tr>
          {% else %}
            <tr><td colspan="5" style="text-align:center;">No courses available.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
  // remember last selected tab per session
  const KEY = 'studentTab';

  function showTab(which) {
    document.querySelectorAll('.tab').forEach(t => {
      t.classList.toggle('active', t.dataset.tab === which);
    });
    document.querySelectorAll('.tab-panel').forEach(p => {
      p.classList.toggle('is-hidden', p.id !== 'tab-' + which);
    });
    try { sessionStorage.setItem(KEY, which); } catch (e) {}
  }

  // restore tab on load
  (function () {
    try {
      const last = sessionStorage.getItem(KEY);
      if (last === 'add') showTab('add'); else showTab('mine');
    } catch (e) { showTab('mine'); }
  })();

  // Show alert message
  function showAlert(message, type) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.style.cssText = `
      padding: 16px 20px;
      margin-bottom: 16px;
      border-radius: 6px;
      font-weight: 500;
      animation: slideDown 0.3s ease-out;
      ${type === 'error' ? 'background-color: #fef2f2; color: #991b1b; border: 1px solid #fecaca;' :
        'background-color: #f0fdf4; color: #166534; border: 1px solid #bbf7d0;'}
    `;
    alert.textContent = message;
    container.innerHTML = '';
    container.appendChild(alert);

    // Auto-hide after 5 seconds
    setTimeout(() => {
      alert.style.animation = 'slideUp 0.3s ease-out';
      setTimeout(() => alert.remove(), 300);
    }, 5000);
  }

  // Enroll in course
  function enroll(courseId) {
    fetch('/api/enroll', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ course_id: courseId })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        showAlert('Successfully enrolled! Refreshing...', 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showAlert(data.error || 'Failed to enroll', 'error');
      }
    })
    .catch(() => {
      showAlert('Network error. Please try again.', 'error');
    });
  }

  // Unenroll from course
  function unenroll(courseId) {
    if (!confirm('Are you sure you want to unenroll from this course?')) return;

    fetch('/api/unenroll', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ course_id: courseId })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        showAlert('Successfully unenrolled! Refreshing...', 'success');
        setTimeout(() => location.reload(), 1500);
      } else {
        showAlert(data.error || 'Failed to unenroll', 'error');
      }
    })
    .catch(() => {
      showAlert('Network error. Please try again.', 'error');
    });
  }
</script>
<style>
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes slideUp {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-10px); }
  }
</style>
{% endblock %}
 